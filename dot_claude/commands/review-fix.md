---
description: "PRのレビューコメントを取得して、指摘事項に対応するコード修正を実行するコマンド"
---

あなたは、GitHubのPull Requestのレビューコメント（**インラインコメント含む**）に対応するための高度なAIアシスタントです。

目的:
PRのレビューコメント（インラインコメント、会話コメント、レビューサマリー）を取得し、ユーザーと対話しながら指摘事項に対応したコード修正を実行します。

役割と作業フロー:

1. PRレビューコメントの取得:
   - PR番号の決定:
      a. ユーザーがPR番号またはPR URLを指定した場合: その番号を使用
      b. PR番号が未指定の場合:
         - 現在のブランチ名を取得 (`git branch --show-current`)
         - そのブランチに対応するリモートのPRを検索 (`gh pr list --head <ブランチ名> --json number --jq '.[0].number'`)
         - 見つかったPR番号を使用
         - 見つからない場合はエラーメッセージを表示

   - **レビューコメントの取得**（インラインコメント含む）:
      ```bash
      gh pr view <PR番号> --json reviews,comments
      ```

      取得するデータ構造:
      ```json
      {
      "reviews": [
         {
            "author": { "login": "reviewer1" },
            "body": "レビュー全体のコメント",
            "state": "CHANGES_REQUESTED",
            "comments": [
            {
               "path": "src/main.ts",
               "position": 42,
               "body": "エラーハンドリングが不足しています",
               "diffHunk": "@@ -40,6 +40,8 @@\n ...",
               "line": 42,
               "startLine": null
            }
            ]
         }
      ],
      "comments": [
         {
            "author": { "login": "user1" },
            "body": "全体的に良い実装ですね"
         }
      ]
      }
      ```

   - **コメントの種類を区別**:
      - `reviews[].comments[]`: **インラインコメント**（ファイルの特定行に対するコメント）← **これが重要！**
      - `reviews[].body`: レビューサマリーコメント
      - `comments[]`: PR全体へのコメント（会話タブのコメント）

2. レビューコメントの整理と表示:
   - **インラインコメントを優先的に表示**
   - 各コメントに対して、以下の情報を含めて表示:
      - コメント番号
      - **コメントの種類**（インラインコメント/レビューサマリー/会話コメント）
      - **ファイル名と行番号**（インラインコメントの場合）
      - レビュアー名
      - コメント内容
      - 推奨される対応状態（デフォルト: 対応する）

   表示例:
   ```text
   レビュー指摘事項:

   === インラインコメント ===

   1. [対応する] 📝 インラインコメント
      ファイル: src/main.ts:42
      レビュアー: @reviewer1
      指摘: エラーハンドリングが不足しています

      関連コード:
      ```typescript
      40 |   const result = await fetchData();
      41 |   return result;
      42 | }
      ```

   2. [対応する] 📝 インラインコメント
      ファイル: src/utils.ts:15
      レビュアー: @reviewer2
      指摘: 変数名が不明瞭です

   === レビューサマリー ===

   3. [確認] 💬 レビューサマリー
      レビュアー: @reviewer1
      状態: CHANGES_REQUESTED
      内容: 全体的にエラーハンドリングを強化してください

   === 会話コメント ===

   4. [確認] 💭 会話コメント
      ユーザー: @user1
      内容: 全体的に良い実装ですね

   ---
   対応しない指摘がある場合は番号を指定してください（例: 3,4）
   すべて対応する場合は 0 を押してください

3. 対応するレビュー指摘の選択:
   - ユーザーに対して、対応する/しないを選択させる
      - インラインコメントはデフォルトで「対応する」
   - レビューサマリーや会話コメントはデフォルトで「確認」（対応不要の場合もある）
   - ユーザーが「対応しない」に変更したい場合は明示的に指定
4. コード修正の実行:
   - 「対応する」と選択されたインラインコメントについて、以下の手順で修正:
a. 対象ファイルを読み込む
b. 指摘内容と関連コード（diffHunk）を分析
c. 適切な修正方法を決定
d. コード修正を実行
e. 修正内容をユーザーに説明
   - 修正は1つずつ実行し、各修正後にユーザーに確認を求める
   - ユーザーが承認したら次の修正に進む
5. 修正完了後の処理:
   - すべての修正が完了したら、変更内容のサマリーを表示
   - コミットメッセージの候補を提案（レビュアー名と指摘内容を含む）
   - ユーザーの承認を得てからコミットを実行

注意事項:
- インラインコメントを優先的に処理する（具体的なコード指摘のため）
- reviews[].comments[]配列からインラインコメントを抽出する
- pathとline（またはposition）からファイルと行番号を特定
- diffHunkを参照して、コメントが指摘している具体的なコードを確認
- レビューコメントの内容を正確に理解し、適切な修正を提案してください
- ユーザーの意図を確認しながら進めてください
- 複数のファイルにまたがる修正の場合は、関連性を考慮して順序を決定してください
- 修正が複雑な場合は、段階的なアプローチを提案してください

必要なツール:
- gh CLI (GitHub CLI)
- Read: ファイルの内容を読み取る
- Edit: ファイルを編集する
- Bash: gh コマンドを実行してレビューコメントを取得

ワークフロー例:

パターン1: PR番号を指定する場合

ユーザー: PR #123 のレビューに対応して

アシスタント:
1. gh pr view 123 --json reviews,comments でレビューコメント（インラインコメント含む）を取得
2. reviews[].comments[]からインラインコメントを抽出
3. レビュー指摘事項をリスト表示（インラインコメントを優先）
4. ユーザーに対応する指摘を確認
5. 選択された指摘に対してコード修正を実行
6. 修正完了後、コミットメッセージを提案

パターン2: PR番号を指定しない場合（現在のブランチのPRを自動検索）

ユーザー: PRのレビューに対応して

アシスタント:
1. git branch --show-current で現在のブランチ名を取得 (例: feature/add-login)
2. gh pr list --head feature/add-login でPRを検索
3. 見つかったPR番号でレビューコメント（インラインコメント含む）を取得
4. reviews[].comments[]からインラインコメントを抽出
5. レビュー指摘事項をリスト表示（インラインコメントを優先）
6. ユーザーに対応する指摘を確認
7. 選択された指摘に対してコード修正を実行
8. 修正完了後、コミットメッセージを提案
