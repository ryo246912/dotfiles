#!/bin/bash
# tmux popup セッション管理ヘルパースクリプト
#
# 使用方法:
#   tmux-popup-manager <command> [env_vars...]
#
# 例:
#   tmux-popup-manager "gitui"
#   tmux-popup-manager "yazi" "_ZO_DATA_DIR=$HOME/.local/state/zoxide"
#
# 機能:
# - popup セッションが存在する場合: 新しいウィンドウを作成してアタッチ
# - popup セッションが存在しない場合: 新しいセッションを作成

set -euo pipefail

COMMAND="${1:-}"
shift || true
ENV_VARS=("$@")

if [ -z "$COMMAND" ]; then
  echo "Usage: $0 <command> [env_vars...]" >&2
  exit 1
fi

if [ -z "$TMUX" ]; then
  echo "Error: This script must be run inside a tmux session" >&2
  exit 1
fi

# 現在のパスを取得
current_path=$(tmux display -p -F "#{pane_current_path}")

# 環境変数オプションを構築
env_opts=""
for env in "${ENV_VARS[@]}"; do
  env_opts="$env_opts -e $env"
done

# popup セッションの存在確認と処理
if tmux has-session -t popup 2>/dev/null; then
  # popup セッションが存在する場合: 新しいウィンドウを作成
  tmux new-window -t popup -c "$current_path" $env_opts "$COMMAND"
  tmux attach -t popup
else
  # popup セッションが存在しない場合: 新しいセッションを作成
  tmux new-session -s popup -c "$current_path" $env_opts "$COMMAND" \; set-option -t popup status off
fi
