#!/usr/bin/env bash

# Reset 5h limit before each work session by sending periodic heartbeats to Claude
# This prevents Claude session timeouts that occur after 5 hours of inactivity

# Ensure only one instance runs
LOCKFILE="/tmp/claude-heartbeat.lock"
if [ -f "$LOCKFILE" ]; then
  pid=$(cat "$LOCKFILE")
  if ps -p "$pid" > /dev/null 2>&1; then
    echo "[claude-heartbeat] Already running (PID: $pid)"
    exit 1
  fi
fi
echo $$ > "$LOCKFILE"
trap "rm -f '$LOCKFILE'" EXIT

SCHEDULED_TIMES=("09:00" "14:05" "20:10")
LOOP_INTERVAL=$((60 * 30)) # 30 minutes
last_run=""

echo "[claude-heartbeat] watching times: ${SCHEDULED_TIMES[*]}"

# Convert time string (HH:MM) to minutes since midnight for reliable comparison
time_to_minutes() {
  local time="$1"
  local hours="${time%:*}"
  local minutes="${time#*:}"
  echo $((10#$hours * 60 + 10#$minutes))
}

while true; do
  now_time="$(date '+%H:%M')"
  now_minutes=$(time_to_minutes "$now_time")
  today="$(date '+%Y-%m-%d')"

  for t in "${SCHEDULED_TIMES[@]}"; do
    t_minutes=$(time_to_minutes "$t")
    key="${today} ${t}"

    # Use >= comparison to catch scheduled times even if skipped by sleep interval
    if [[ "$now_minutes" -ge "$t_minutes" && "$last_run" != "$key" ]]; then
      last_run="$key"
      echo "[$(date '+%Y-%m-%d %H:%M:%S')] Sending heartbeat to Claude..."

      # Retry logic: attempt up to 2 times with 5-second intervals
      max_retries=2
      retry_count=0
      success=false

      while [ $retry_count -lt $max_retries ]; do
        if claude -p "hello" >/dev/null 2>&1; then
          echo "✔ Claude responded"
          success=true
          break
        else
          retry_count=$((retry_count + 1))
          if [ $retry_count -lt $max_retries ]; then
            echo "⚠ Retry $retry_count/$max_retries after 5s..."
            sleep 5
          fi
        fi
      done

      if [ "$success" = false ]; then
        echo "✖ Claude failed after $max_retries attempts"
      fi
    fi
  done

  sleep "$LOOP_INTERVAL"
done
