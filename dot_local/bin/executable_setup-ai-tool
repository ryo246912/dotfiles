#!/bin/bash

# Check for required binaries
if ! command -v claude &> /dev/null; then
  echo "✖ Error: 'claude' command not found. Please install Claude CLI first."
  exit 1
fi

if ! command -v bun &> /dev/null; then
  echo "✖ Error: 'bun' command not found. Please install bun first."
  exit 1
fi

export DISABLE_AUTOUPDATER=1

# Get MCP list once and reuse it
MCP_LIST=$(claude mcp list 2>/dev/null)

# Helper function to check if MCP is already registered
mcp_exists() {
  local name="$1"
  echo "$MCP_LIST" | grep -q "\"$name\"" && return 0 || return 1
}

# MCPs to add
MCP_NAMES=(
  # "context7"
  "deepwiki"
  # "chrome-devtools"
  "modular-mcp"
)
MCP_ARGS=(
  # "-s user --transport http context7 https://mcp.context7.com/mcp"
  "-s user -t http deepwiki https://mcp.deepwiki.com/mcp"
  # "-s user chrome-devtools bunx chrome-devtools-mcp@latest"
  "--transport stdio -s user modular-mcp -- npx -y @kimuson/modular-mcp $HOME/.claude/modular-mcp.json"
)

# Function to add or skip MCP
add_or_skip_mcp() {
  local name="$1"
  local args="$2"

  if ! mcp_exists "$name"; then
    echo "Adding $name MCP..."
    local output
    output=$(eval "claude mcp add $args" 2>&1)
    if [ $? -eq 0 ]; then
      echo "✔ $name MCP added"
      return 0
    elif echo "$output" | grep -q "already exists"; then
      echo "✓ $name MCP already registered"
      return 0
    else
      echo "✖ Failed to add $name MCP"
      echo "$output"
      return 1
    fi
  else
    echo "✓ $name MCP already registered"
    return 0
  fi
}

# Add MCPs if not already present
echo "[setup-ai-tool] Configuring Claude MCPs..."

for i in "${!MCP_NAMES[@]}"; do
  if ! add_or_skip_mcp "${MCP_NAMES[$i]}" "${MCP_ARGS[$i]}"; then
    exit 1
  fi
done

echo "[setup-ai-tool] Setup completed successfully!"
# TODO: anthropics/skills plugin will be added once marketplace is stable
# /plugin marketplace add anthropics/skills
